name: Release PopClip Extension

on:
  push:
    tags:
      - 'v*'  # 触发条件：推送以 v 开头的标签，如 v1.0.0

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get tag name
      id: tag
      run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create extension package
      run: |
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la

        # 检查扩展目录是否存在
        if [ ! -d "QuoteComma.popclipext" ]; then
          echo "Error: QuoteComma.popclipext directory not found!"
          exit 1
        fi

        echo "Extension directory contents:"
        ls -la QuoteComma.popclipext/

        # 创建 zip 文件，包含整个 .popclipext 文件夹
        # 这样解压后会得到 QuoteComma.popclipext/ 文件夹
        zip -r QuoteComma-${{ steps.tag.outputs.tag }}.popclipextz QuoteComma.popclipext/

        # 验证文件创建成功
        echo "Created package:"
        ls -la *.popclipextz

        # 检查文件大小
        du -h *.popclipextz

        # 测试解压验证结构
        echo "Testing package structure:"
        unzip -l QuoteComma-${{ steps.tag.outputs.tag }}.popclipextz
        
    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## PopClip Quote Extension ${{ steps.tag.outputs.tag }}
        
        ### 功能特性
        - 🔄 **灵活分割**: 支持换行符、空格、混合分割模式
        - 🎯 **智能引号**: 自动处理已有引号，支持多层嵌套
        - 📝 **输出格式**: 多行或单行格式可选
        - 💬 **简洁界面**: SF Symbols 引号气泡图标
        - 🔇 **静默操作**: 无弹窗提示，自动复制到剪贴板
        
        ### 安装方法
        1. 下载 `QuoteComma-${{ steps.tag.outputs.tag }}.popclipextz` 文件
        2. 双击文件，macOS 会自动解压并用 PopClip 打开
        3. PopClip 会自动安装扩展
        4. 在 PopClip 扩展选项中配置分割方式和输出格式

        ### 手动安装（如果双击失败）
        1. 将 `.popclipextz` 文件重命名为 `.zip`
        2. 解压得到 `QuoteComma.popclipext` 文件夹
        3. 双击 `QuoteComma.popclipext` 文件夹安装
        
        ### 系统要求
        - macOS with PopClip installed
        - PopClip version 2021.5 or later
        
        ### 使用示例
        **输入文本:**
        ```
        ip：192.168.1.100
        子网：255.255.255.0
        网关：192.168.1.1
        ```
        
        **输出结果:**
        ```
        "ip：192.168.1.100",
        "子网：255.255.255.0",
        "网关：192.168.1.1"
        ```
        EOF
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: PopClip Quote Extension ${{ steps.tag.outputs.tag }}
        body_path: release_notes.md
        files: |
          QuoteComma-${{ steps.tag.outputs.tag }}.popclipextz
        draft: false
        prerelease: false
        make_latest: true
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: popclip-extension-${{ steps.tag.outputs.tag }}
        path: QuoteComma-${{ steps.tag.outputs.tag }}.popclipextz
        retention-days: 30
